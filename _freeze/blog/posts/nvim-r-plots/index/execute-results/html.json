{
  "hash": "e1990c0aea943946f56ddbf56e7901c1",
  "result": {
    "markdown": "---\ntitle: \"Integrating R Graphics with Neovim and Nvim-R\"\ndate: 2023-06-25\n# bibliography: references.yaml\ncategories: [\"nvim\", \"R\", \"setup\"]\n---\n\n\nThe Nvim-R plugin extends a lot of RStudio functionality to Neovim like an object browser, help menu, and interactive terminal but the default plotting experience leaves a lot to be desired.\n\nWhile RStudio levels of integration may be out of reach there are several ways it can be improved. Doing so just requires going outside of Neovim.\n\nHere is what it will look like when its all done.\n\n![](demo.gif)\n\n::: {.callout-note}\n#### Requirements\nThis guide assumes you already have Neovim and Nvim-R installed.\n:::\n\n## The Problem\n\nGUI editors like RStudio and VSCode can quite easily integrate plots into a pane either by defining their own output device or redirecting the output of an existing device to the application. \n\nTerminal based editor's like Neovim do not support graphics and so cannot display the output inside the app. Instead they delegate the graphics to a separate program running in a separate window. By default this leaves Nvim-R plots popping up in the middle of your screen, and falling behind your Neovim window with every edit you make. Additionally the default plotting window does not keep a plot history so each new plot overwrites the previous one. \n\n## The Workaround\n\nLuckily improving the experience is as simple as configuring the behaviour of that external window.\n\nThe default window device used by R depends on your operating system but they all have a fairly consistent set of options that can be specified either as defaults through the .options method or on window creation as arguments.\n\n::: {.callout-warning}\n#### OS Differences\nI'll be using the `windows` device. Linux users should use `x11` and MacOS users `quartz`.\n\nThere may be minor differences between the options and behaviour of these devices. Check the R documentation for these devices under the `grDevices` library if things aren't behaving as expected.\n:::\n\n## .Rprofile\n\nThe best place to change the default behaviour of the plotting window is in a .Rprofile file. This script runs when R starts and can be used to configure all sorts of user preferences. R looks for .Rprofile in three places: the current directory, the home directory, and the installation directory.\n\nThe user home directory can be found with the command `path.expand(\"~\")`. It is not the same as the user's home directory. Mine is in my Documents folder.\n\nCreate a text file in that directory called `.Rprofile` and write `print(\"Loaded .Rprofile\")`. If everything is in the right place, when you open an R terminal you should see the message below the startup text.\n\n::: {.callout-tip}\n#### While You're There\n.Rprofile can configure more than just the graphics device. Some especially useful settings are:\n\n::: {.cell filename='Default CRAN Mirror'}\n\n```{.r .cell-code}\nlocal({r <- getOption(\"repos\")\n      r[\"CRAN\"] <- \"https://mirror.csclub.uwaterloo.ca/CRAN/\"\n      options(repos=r)})\n```\n:::\n\nand\n\n::: {.cell filename='Disable Scientific Notation'}\n\n```{.r .cell-code}\noptions(scipen=10)\n```\n:::\n\n:::\n\n\n## Setting Defaults\n\nUnfortunately .Rprofile is loaded before the grDevices library so the `windows.options` method can't be called directly. Instead you have to set a hook that will wait until grDevices is ready.\n\n\n::: {.cell filename='.Rprofile'}\n\n```{.r .cell-code}\nsetHook(packageEvent(\"grDevices\", \"onLoad\"),\n        function(...) {\n          # Your Settings\n        })\n```\n:::\n\n\nThe settings I use are:\n\n::: {.cell}\n\n```{.r .cell-code}\ngrDevices::windows.options(\n  # Save the plot history\n  record = TRUE,\n  # Position the display in the bottom right corner of main monitor\n  width = 4,\n  height = 3,\n  xpos = 1273,\n  ypos = 668\n)\nif (interactive()) {\n  # Open an empty window with a distinctive title for ahk window detection\n  grDevices::windows(title = \"Nvim-R Plot\")\n  # Set that window to stay on top\n  grDevices::bringToTop(which = grDevices::dev.cur(), stay = TRUE)\n}\n```\n:::\n\n\nThis overcomes all the main issues with the default plotting experience. The plot history is retained, the window is contained to a defined zone of the screen, and it always stays on top of Neovim.\n\n# Final Refinements\n\nFor finishing touches we can configure Nvim-R to create an extra buffer for the plotting window to go over. I do this by setting these options in my Nvim-R config.\n```lua\n-- Create empty pane at bottom right\nvim.g.R_after_start = {':winc j', ':vsplit', ':vertical resize ' .. math.floor(vim.fn.winwidth(0) / 3), \":winc k\"}\n-- Place object browser above plot pane\nvim.g.R_objbr_place = 'script,right'\n```\nThis ensures console and object browser output is not blocked by the plot.\n\nThen I use Autohotkey to hide the plot window's title bar whenever I start R from Neovim with the `\\rf` keymapping.\n```lua\n#HotIf WinActive(\"ahk_exe WindowsTerminal.exe\")\n:*?B0:\\rf:: {\n    win := WinWait(\"Nvim-R Plot\", , 10)\n    if win {\n        WinActivate win ; to stop the notification\n        WinSetStyle \"-0xC00000\", win\n        Sleep 50\n        WinActivate \"ahk_exe WindowsTerminal.exe\"\n    }\n}\n```\n\nFinally, while opening in the bottom corner is a big improvement from the default you can make things even more precise with some more AHK.\n\nThis function finds the location of the pane from a screenshot of the pane intersection and automatically moves the plot window into position. \n```lua\nMovePlot() {\n    plot := WinExist(\"Nvim-R Plot\")\n    if not plot \n        return\n    WinGetPos , , &width, &height, \"A\"\n    WinSetAlwaysontop True, \"A\"\n    if ImageSearch(&x, &y, 0, 0, A_ScreenWidth, A_ScreenHeight, \"r_plot_location.png\")\n        WinMove x + 1, y + 3, width - x - 10, height - y - 70, plot\n    WinSetAlwaysontop False, \"A\"\n}\nScrollLock::MovePlot()\n#HotIf\n```\nI call this function on plot open as well as with the ScrollLock hotkey when I move the window.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}